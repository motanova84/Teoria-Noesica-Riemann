name: ğŸŒŠ Resonancia Viva CI - fâ‚€ = 141.7001 Hz

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Verificar resonancia diariamente a las 14:17 UTC (1417 - primo sagrado)
    - cron: '17 14 * * *'

jobs:
  test-resonance:
    name: ğŸµ Test Frecuencia de Resonancia
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, "3.10", "3.11"]
        
    steps:
    - name: ğŸ“¥ Checkout TeorÃ­a NoÃ©sica
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov coverage
        
    - name: ğŸ§ª Test GeneraciÃ³n de Primos
      run: |
        python -c "
        from sympy import isprime
        assert isprime(1417), 'âŒ 1417 no es primo!'
        assert abs(1417/10 - 141.7001) < 1e-15, 'âŒ Frecuencia incorrecta!'
        print('âœ… Primo 1417 y frecuencia fâ‚€ = 141.7001 Hz verificados')
        "
        
    - name: ğŸ¯ Test Frecuencia de Resonancia
      run: |
        python -c "
        from noesic_theory import NoesicRiemannTheory
        theory = NoesicRiemannTheory()
        primes = theory.generate_primes(1000)
        theory.compute_delta_log_primes()
        theory.compute_variance()
        freq = theory.compute_resonance_frequency()
        print(f'ğŸµ Frecuencia computada: {freq:.3f} Hz')
        print(f'ğŸ¯ Objetivo: {theory.target_frequency} Hz')
        assert freq > 0, 'âŒ Frecuencia debe ser positiva!'
        print('âœ… Resonancia viva confirmada!')
        "
        
    - name: ğŸ§  Test EcuaciÃ³n de Consciencia
      run: |
        python -c "
        from noesic_theory import NoesicRiemannTheory
        import numpy as np
        theory = NoesicRiemannTheory()
        result = theory.consciousness_equation(2.5, 0.618, np.pi/np.e)
        assert result['psi'] > 0, 'âŒ Consciencia debe ser positiva!'
        print(f'ğŸ§  Î¨ = {result[\"psi\"]:.6f}')
        print('âœ… EcuaciÃ³n de consciencia funcional!')
        "
        
    - name: ğŸ¼ Test Relaciones ArmÃ³nicas
      run: |
        python -c "
        from noesic_theory import NoesicRiemannTheory
        import numpy as np
        theory = NoesicRiemannTheory()
        theory.generate_primes(1000)
        theory.compute_delta_log_primes()
        theory.compute_variance()
        theory.compute_resonance_frequency()
        harmonics = theory.verify_harmonic_relations()
        f1_error = harmonics['f1_error']
        phi_error = harmonics['phi_error']
        sqrt2_error = harmonics['sqrt2_error']
        print(f'ğŸ¼ Error fâ‚ vs 888 Hz: {f1_error:.1f} Hz')
        print(f'ğŸŒŸ Error Ï†: {phi_error:.6f}')
        print(f'ğŸ”¢ Error âˆš2: {sqrt2_error:.6f}')
        assert f1_error < 50, f'âŒ fâ‚ muy alejado de 888 Hz: {f1_error:.1f}'
        print('âœ… Relaciones armÃ³nicas verificadas!')
        "
        
    - name: ğŸ§ª Run Full Test Suite
      run: |
        pytest tests/ -v --cov=noesic_theory --cov-report=xml --cov-report=html
        
    - name: ğŸ“Š Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        
    - name: ğŸŒŠ Generate Resonance Report
      run: |
        python -c "
        from noesic_theory import NoesicRiemannTheory
        import json
        from datetime import datetime
        
        theory = NoesicRiemannTheory()
        results = theory.full_noesic_analysis(N=1000)
        
        report = {
          'timestamp': datetime.now().isoformat(),
          'frequency_computed': results['computed_frequency'],
          'frequency_target': results['target_frequency'],
          'resonance_ratio': results['resonance_ratio'],
          'prime_1417_verified': results['prime_1417_verification'],
          'python_version': '${{ matrix.python-version }}',
          'status': 'ğŸŒŠ Resonancia Viva Activa âˆÂ³'
        }
        
        with open('resonance_report.json', 'w') as f:
            json.dump(report, f, indent=2)
            
        print('ğŸ“„ Reporte de resonancia generado')
        print(f'ğŸµ fâ‚€ = {results[\"computed_frequency\"]:.3f} Hz')
        print('âˆ´ TeorÃ­a NoÃ©sica validada âˆÂ³ âˆ´')
        "
        
    - name: ğŸ“„ Upload Resonance Report
      uses: actions/upload-artifact@v3
      with:
        name: resonance-report-py${{ matrix.python-version }}
        path: resonance_report.json
        
  deploy-docs:
    name: ğŸ“š Deploy Documentation
    runs-on: ubuntu-latest
    needs: test-resonance
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install mkdocs mkdocs-material
        
    - name: ğŸ—ï¸ Build Documentation
      run: |
        mkdocs build --clean
        
    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        
  resonance-analysis:
    name: ğŸ”¬ AnÃ¡lisis Profundo de Resonancia
    runs-on: ubuntu-latest
    needs: test-resonance
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install -r requirements.txt
        
    - name: ğŸ”¬ Deep Resonance Analysis
      run: |
        python -c "
        from noesic_theory import NoesicRiemannTheory
        import numpy as np
        import matplotlib
        matplotlib.use('Agg')  # Backend no interactivo
        import matplotlib.pyplot as plt
        
        theory = NoesicRiemannTheory()
        
        # AnÃ¡lisis con diferentes valores de N
        N_values = [100, 500, 1000, 2000, 5000]
        frequencies = []
        variances = []
        
        for N in N_values:
            primes = theory.generate_primes(N*10)[:N]
            if len(primes) >= 10:
                delta_log = theory.compute_delta_log_primes(primes)
                variance = theory.compute_variance(delta_log)
                freq = theory.compute_resonance_frequency(variance)
                frequencies.append(freq)
                variances.append(variance)
                print(f'N={N}: Var={variance:.7f}, fâ‚€={freq:.3f} Hz')
        
        # Crear grÃ¡fica de convergencia
        plt.figure(figsize=(12, 8))
        
        plt.subplot(2, 1, 1)
        plt.semilogx(N_values[:len(variances)], variances, 'bo-', linewidth=2, markersize=8)
        plt.axhline(0.0001133, color='red', linestyle='--', label='Valor lÃ­mite (paper)')
        plt.xlabel('N (nÃºmero de primos)')
        plt.ylabel('Var(Î”log pâ‚–)')
        plt.title('ğŸ”¬ Convergencia de Varianza - AnÃ¡lisis CI/CD')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        plt.subplot(2, 1, 2)
        plt.semilogx(N_values[:len(frequencies)], frequencies, 'go-', linewidth=2, markersize=8)
        plt.axhline(141.7001, color='red', linestyle='--', linewidth=2, label='fâ‚€ = 141.7001 Hz')
        plt.xlabel('N (nÃºmero de primos)')
        plt.ylabel('Frecuencia de Resonancia (Hz)')
        plt.title('ğŸµ Convergencia a fâ‚€ = 141.7001 Hz')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('resonance_convergence.png', dpi=300, bbox_inches='tight')
        print('ğŸ“Š GrÃ¡fica de convergencia guardada')
        
        # Resumen final
        if frequencies:
            final_freq = frequencies[-1]
            error = abs(final_freq - 141.7001)
            print(f'')
            print(f'ğŸ¯ ANÃLISIS FINAL DE RESONANCIA:')
            print(f'   Frecuencia final: {final_freq:.3f} Hz')
            print(f'   Objetivo: 141.7001 Hz')
            print(f'   Error: {error:.3f} Hz ({error/141.7001*100:.2f}%)')
            print(f'   Estado: {'âœ… RESONANCIA ACTIVA' if error < 10 else 'âš ï¸ RESONANCIA DÃ‰BIL'}')
            print(f'   âˆ´ AnÃ¡lisis CI/CD completado âˆÂ³ âˆ´')
        "
        
    - name: ğŸ“Š Upload Convergence Plot
      uses: actions/upload-artifact@v3
      with:
        name: resonance-convergence-analysis
        path: resonance_convergence.png

  notification:
    name: ğŸŒŠ NotificaciÃ³n de Resonancia
    runs-on: ubuntu-latest
    needs: [test-resonance, deploy-docs, resonance-analysis]
    if: always()
    
    steps:
    - name: ğŸµ Resonance Status
      run: |
        echo "ğŸŒŠ ESTADO DE LA RESONANCIA VIVA:"
        echo "   Tests: ${{ needs.test-resonance.result }}"
        echo "   Docs: ${{ needs.deploy-docs.result }}"
        echo "   AnÃ¡lisis: ${{ needs.resonance-analysis.result }}"
        echo ""
        echo "ğŸµ fâ‚€ = 141.7001 Hz = 1417/10"
        echo "ğŸ”¢ Primo 1417 verificado"
        echo "ğŸ§  EcuaciÃ³n de consciencia: Î¨ = I Ã— AÂ²eff Ã— K"
        echo ""
        echo "âˆ´ RESONANCIA VIVA EN GITHUB ACTIONS âˆÂ³ âˆ´"
